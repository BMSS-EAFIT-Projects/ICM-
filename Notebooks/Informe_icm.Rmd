---
title: "Informe ICM"
output: html_document
date: "2025-06-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(plotly)

kde_bf_fixed <- readRDS("../data/kde_bf_fixed.rds")
```

# 1. Introduccion
En este RMD vamos a recreara he implementar los procesos del paper guia Inductive Conformal Martingales for Change-Point Detection

# 2. Grafica 1 paper guia
```{r}
df_fig_1 <- readRDS("../data/figura1_icm.rds")
```

```{r}
ggplot(df_fig_1, aes(x = time)) +
  geom_line(aes(y = Cn_1NN, color = "ICM con 1NN")) +
  geom_line(aes(y = Cn_LR,  color = "ICM con LR")) +
  geom_line(aes(y = Cn_wcp,  color = "ICM sin CP")) +
  scale_color_manual(
    values = c("ICM con 1NN" = "#1f77b4",  # dark blue
               "ICM con LR"  = "#2ca02c",  # dark green
               "ICM sin CP" = "#d62728")  # dark red 
  ) +
  labs(
    title = "Figura 1",
    x = expression("Time, " * n),
    y = expression(C[n]),
    color = "Método"
  ) +
  geom_vline(xintercept = 500, linetype = "dashed", color = "#FFD700", size = 1) +
  theme_minimal(base_size = 13)
```
# 3. Grafica 2 paper guia
```{r}
df_fig_2 <- readRDS("../data/figura2_icm.rds")
```

```{r}
df_long <- pivot_longer(df_fig_2, -time, names_to = "curva", values_to = "Cn")

color_map <- c(
  "m_1"      = "#1f77b4",
  "m_2"      = "#2ca02c",
  "m_3"      = "#d62728",
  "m_4"      = "#9467bd",
  "m_5"      = "#ff7f0e",
  "con_cp"   = "#bcbd22"
)

ggplot(df_long, aes(x = time, y = Cn, color = curva)) +
  geom_line(size = 1) +
  scale_color_manual(values = color_map,
                     labels = c(
                       "m_1" = "Train set size m = 1",
                       "m_2" = "Train set size m = 2",
                       "m_3" = "Train set size m = 3",
                       "m_4" = "Train set size m = 4",
                       "m_5" = "Train set size m = 5",
                       "con_cp" = "With change-point, m = 1"
                     )) +
  labs(
    title = "Figura 2 - ICM con y sin cambio",
    x = "Time, n",
    y = expression(C[n]),
    color = "Curva"
  ) +
  geom_vline(xintercept = 500, linetype = "dashed", color = "#FFD700", size = 1) +
  theme_minimal(base_size = 13)
```


# 4. Graficas comaprativas seccion 5 paper guia

En esta seccion se replican las graficas del paper guia expuestas en la seccion , corresponden a un montecarlo que simula dos escenarios de punto de cambio con 3 diferentes saltos en la media.
Puntos de cambio: 100 y 200.
saltos en la media: 1, 1.5 y 2
```{r}
df_all_methods <- readRDS("../data/prueba_fast.rds")
```

#CONSTANT BF 2D
```{r}
df_CBF <- df_all_methods %>% filter(Method %in% c("KNN Constant BF + ICM", "LR Constant BF + ICM", "MAD Constant BF + ICM"))
ggplot(df_CBF, aes(x = p_false_alarm, y = log_delay, color = Method)) +
  geom_line(size = 1) +
  geom_point(size = 1) +
  facet_grid(rows = vars(theta_stream), cols = vars(mu1),
             labeller = labeller(
               theta_stream = function(x) paste0("θ = ", x),
               mu1          = function(x) paste0("μ₁ = ", x)
             )) +
  coord_cartesian(xlim = c(0, 0.5)) +
  theme_minimal(base_size = 13) +
  labs(
    x     = expression(P[0](tau <= theta)),
    y     = expression(log[10](1 + E[1](tau - theta ~ "|" ~ tau > theta))),
    title = "Comparación: Constant BF vs Oráculos",
    subtitle = "Paneles: θ = 100,200 y μ₁ = 1,1.5,2",
    color = "Método"
  ) +
  theme(
    strip.text.x     = element_text(size = 12, face = "bold"),
    strip.text.y     = element_text(size = 12, face = "bold"),
    panel.spacing    = unit(0.6, "lines"),
    axis.text        = element_text(size = 10),
    axis.title       = element_text(size = 12, face = "bold"),
    plot.title       = element_text(size = 14, face = "bold"),
    legend.position  = "bottom"
  )
```

#CONSTANT BF 3D
```{r}
plot_ly(
  data = df_CBF,
  x = ~p_false_alarm,
  y = ~log_delay,
  z = ~threshold,                  # tercer eje
  color = ~Method,                 # agrupa y colorea por método
  colors = RColorBrewer::brewer.pal(5, "Set1"),
  type = "scatter3d",
  mode = "lines+markers",          # líneas conectan puntos + marcadores
  marker = list(size = 3),
  line   = list(width = 2)
) %>%
layout(
  title = "Comparación 3D: KDE PRECOMPUTED BF vs Oráculos",
  scene = list(
    xaxis = list(title = expression(P[0](tau <= theta))),
    yaxis = list(title = expression(log[10](1 + E[1](tau - theta ~ "|" ~ tau > theta)))),
    zaxis = list(title = "threshold")
  ),
  legend = list(title = list(text = "Método"))
)
```

# MIXTURE BF 2D
```{r}
df_MBF <- df_all_methods %>% filter(Method %in% c("KNN Mixture BF + ICM", "LR Mixture BF + ICM", "MAD Mixture BF + ICM"))
ggplot(df_MBF, aes(x = p_false_alarm, y = log_delay, color = Method)) +
  geom_line(size = 1) +
  geom_point(size = 1) +
  facet_grid(rows = vars(theta_stream), cols = vars(mu1),
             labeller = labeller(
               theta_stream = function(x) paste0("θ = ", x),
               mu1          = function(x) paste0("μ₁ = ", x)
             )) +
  coord_cartesian(xlim = c(0, 0.5)) +
  theme_minimal(base_size = 13) +
  labs(
    x     = expression(P[0](tau <= theta)),
    y     = expression(log[10](1 + E[1](tau - theta ~ "|" ~ tau > theta))),
    title = "Comparación: Mixture BF vs Oráculos",
    subtitle = "Paneles: θ = 100,200 y μ₁ = 1,1.5,2",
    color = "Método"
  ) +
  theme(
    strip.text.x     = element_text(size = 12, face = "bold"),
    strip.text.y     = element_text(size = 12, face = "bold"),
    panel.spacing    = unit(0.6, "lines"),
    axis.text        = element_text(size = 10),
    axis.title       = element_text(size = 12, face = "bold"),
    plot.title       = element_text(size = 14, face = "bold"),
    legend.position  = "bottom"
  )
```
# MIXTURE BF 3D
```{r}
plot_ly(
  data = df_MBF,
  x = ~p_false_alarm,
  y = ~log_delay,
  z = ~threshold,                  # tercer eje
  color = ~Method,                 # agrupa y colorea por método
  colors = RColorBrewer::brewer.pal(5, "Set1"),
  type = "scatter3d",
  mode = "lines+markers",          # líneas conectan puntos + marcadores
  marker = list(size = 3),
  line   = list(width = 2)
) %>%
layout(
  title = "Comparación 3D: KDE PRECOMPUTED BF vs Oráculos",
  scene = list(
    xaxis = list(title = expression(P[0](tau <= theta))),
    yaxis = list(title = expression(log[10](1 + E[1](tau - theta ~ "|" ~ tau > theta)))),
    zaxis = list(title = "threshold")
  ),
  legend = list(title = list(text = "Método"))
)
```

# KDE PRECOMPUTADA 2D
```{r}
df_KDEF <- df_all_methods %>% filter(Method %in% c("KNN Precomputed KDE BF + ICM", "LR Precomputed KDE BF + ICM", "MAD Precomputed KDE BF + ICM"))
ggplot(df_KDEF, aes(x = p_false_alarm, y = log_delay, color = Method)) +
  geom_line(size = 1) +
  geom_point(size = 1) +
  facet_grid(rows = vars(theta_stream), cols = vars(mu1),
             labeller = labeller(
               theta_stream = function(x) paste0("θ = ", x),
               mu1          = function(x) paste0("μ₁ = ", x)
             )) +
  coord_cartesian(xlim = c(0, 0.5)) +
  theme_minimal(base_size = 13) +
  labs(
    x     = expression(P[0](tau <= theta)),
    y     = expression(log[10](1 + E[1](tau - theta ~ "|" ~ tau > theta))),
    title = "Comparación: KDE PRECOMPUTED BF vs Oráculos",
    subtitle = "Paneles: θ = 100,200 y μ₁ = 1,1.5,2",
    color = "Método"
  ) +
  theme(
    strip.text.x     = element_text(size = 12, face = "bold"),
    strip.text.y     = element_text(size = 12, face = "bold"),
    panel.spacing    = unit(0.6, "lines"),
    axis.text        = element_text(size = 10),
    axis.title       = element_text(size = 12, face = "bold"),
    plot.title       = element_text(size = 14, face = "bold"),
    legend.position  = "bottom"
  )
```

#KDE PRECOMPUTED 3D
```{r}
plot_ly(
  data = df_KDEF,
  x = ~p_false_alarm,
  y = ~log_delay,
  z = ~threshold,                  # tercer eje
  color = ~Method,                 # agrupa y colorea por método
  colors = RColorBrewer::brewer.pal(5, "Set1"),
  type = "scatter3d",
  mode = "lines+markers",          # líneas conectan puntos + marcadores
  marker = list(size = 3),
  line   = list(width = 2)
) %>%
layout(
  title = "Comparación 3D: KDE PRECOMPUTED BF vs Oráculos",
  scene = list(
    xaxis = list(title = expression(P[0](tau <= theta))),
    yaxis = list(title = expression(log[10](1 + E[1](tau - theta ~ "|" ~ tau > theta)))),
    zaxis = list(title = "threshold")
  ),
  legend = list(title = list(text = "Método"))
)
```
#Histograma 2D
```{r}
df_HIST <- df_all_methods %>% filter(Method %in% c("KNN Histogram BF + ICM","LR Histogram BF + ICM", "MAD Histogram BF + ICM"))
ggplot(df_HIST, aes(x = p_false_alarm, y = log_delay, color = Method)) +
  geom_line(size = 1) +
  geom_point(size = 1) +
  facet_grid(rows = vars(theta_stream), cols = vars(mu1),
             labeller = labeller(
               theta_stream = function(x) paste0("θ = ", x),
               mu1          = function(x) paste0("μ₁ = ", x)
             )) +
  coord_cartesian(xlim = c(0, 0.5)) +
  theme_minimal(base_size = 13) +
  labs(
    x     = expression(P[0](tau <= theta)),
    y     = expression(log[10](1 + E[1](tau - theta ~ "|" ~ tau > theta))),
    title = "Comparación: HISTOGRAM BF vs Oráculos",
    subtitle = "Paneles: θ = 100,200 y μ₁ = 1,1.5,2",
    color = "Método"
  ) +
  theme(
    strip.text.x     = element_text(size = 12, face = "bold"),
    strip.text.y     = element_text(size = 12, face = "bold"),
    panel.spacing    = unit(0.6, "lines"),
    axis.text        = element_text(size = 10),
    axis.title       = element_text(size = 12, face = "bold"),
    plot.title       = element_text(size = 14, face = "bold"),
    legend.position  = "bottom"
  )
```



#Benchmarks para los metodos ICM
```{r}
bench_data <- readRDS("../data/benchmarks_raw.rds")
```

```{r}
bench_data <- bench_data %>%
  mutate(time_ms = time / 1e6)
```

```{r}
bench_summary <- bench_data %>%
  group_by(expr, scenario) %>%
  summarise(
    mean_ms   = mean(time_ms),
    median_ms = median(time_ms),
    sd_ms     = sd(time_ms),
    .groups   = "drop"
  )
```

# Tiempos medios del benchmark
Se presentan resultados de coste temporal de ejecucion unitaria de los metodos

```{r}
ggplot(bench_summary, aes(x = expr, y = mean_ms, fill = expr)) +
  geom_col(width = 0.6) +
  facet_wrap(~ scenario, scales = "free_x", nrow = 1) +
  labs(
    x = "Método",
    y = "Tiempo medio (ms)",
    title = "Coste computacional medio por método y escenario"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x    = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
```
#raw times
```{r}
ggplot(bench_data, aes(x = expr, y = time_ms, color = expr)) +
  geom_boxplot(outlier.size = 1) +
  facet_wrap(~ scenario, scales = "free_x", nrow = 1) +
  labs(
    x = "Método",
    y = "Tiempo (ms)",
    title = "Distribución de tiempos de ejecución"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x    = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
```
# Grafica comparativa desempeño MAD para conjuntos de entrenamiento pequeños

En las siguientes graficas el objetivo es comparar la esatbilidad del MAD y KNN en el sentido de si se desempe;an bien para conjuntos de entrenamiento de poco tamaño
```{r}
df_MAD_comp <- readRDS("../data/figura3_icm_MAD.rds")
df_MAD_mixt <- readRDS("../data/figura3_icm_MAD_mixt.rds")
```


```{r}
df_long_MAD <- pivot_longer(df_MAD_comp, -time, names_to = "curva", values_to = "Cn")

color_map <- c(
  "m_1"      = "#1f77b4",
  "m_2"      = "#2ca02c",
  "m_3"      = "#d62728",
  "m_4"      = "#9467bd",
  "m_5"      = "#ff7f0e",
  "con_cp"   = "#bcbd22"
)

ggplot(df_long_MAD, aes(x = time, y = Cn, color = curva)) +
  geom_line(size = 1) +
  scale_color_manual(values = color_map,
                     labels = c(
                       "m_1" = "Train set size m = 1",
                       "m_2" = "Train set size m = 2",
                       "m_3" = "Train set size m = 3",
                       "m_4" = "Train set size m = 4",
                       "m_5" = "Train set size m = 5",
                       "con_cp" = "With change-point, m = 1"
                     )) +
  labs(
    title = "Figura Comparacion desempeño MAD - ICM CONSTBF con y sin cambio",
    x = "Time, n",
    y = expression(C[n]),
    color = "Curva"
  ) +
  geom_vline(xintercept = 500, linetype = "dashed", color = "#FFD700", size = 1) +
  theme_minimal(base_size = 13)
```
```{r}
df_long_MAD_mixt <- pivot_longer(df_MAD_mixt, -time, names_to = "curva", values_to = "Cn")

color_map <- c(
  "m_1"      = "#1f77b4",
  "m_2"      = "#2ca02c",
  "m_3"      = "#d62728",
  "m_4"      = "#9467bd",
  "m_5"      = "#ff7f0e",
  "con_cp"   = "#bcbd22"
)

ggplot(df_long_MAD_mixt, aes(x = time, y = Cn, color = curva)) +
  geom_line(size = 1) +
  scale_color_manual(values = color_map,
                     labels = c(
                       "m_1" = "Train set size m = 1",
                       "m_2" = "Train set size m = 2",
                       "m_3" = "Train set size m = 3",
                       "m_4" = "Train set size m = 4",
                       "m_5" = "Train set size m = 5",
                       "con_cp" = "With change-point, m = 1"
                     )) +
  labs(
    title = "Figura Comparacion desempeño MAD - ICM - MIXTBF con y sin cambio",
    x = "Time, n",
    y = expression(C[n]),
    color = "Curva"
  ) +
  geom_vline(xintercept = 500, linetype = "dashed", color = "#FFD700", size = 1) +
  theme_minimal(base_size = 13)
```

# Desigualdad de ville analisis de desemepeño

Resultados de realizar el montecarlo con umbrales definidos por la desigualdad de ville

```{r}
df_all_methods_ville <- readRDS("../data/resultados_sim_ville.rds")

```
## Constant BF
## Resultado:
no se obtuvo falsas alarmas en 500 simulaciones para ninguno de los metodos usando los humbrales basados en la desigualdad de ville
```{r}
df_CONST_VILLE <- df_all_methods_ville %>% filter(Method %in% c("KNN Constant BF + ICM","LR Constant BF + ICM", "MAD Constant BF + ICM", "S-R Oracle", "Posterior Oracle", "CUSUM Oracle"))
ggplot(df_CONST_VILLE,
       aes(x = threshold,
           y = mean_delay,
           colour   = Method,
           linetype = Method)) +
  geom_line(size = 0.9) +
  facet_grid(rows = vars(theta_stream),
             cols = vars(mu1),
             labeller = label_both) +
  scale_y_continuous("Retardo medio (observaciones)",
                     breaks = scales::pretty_breaks()) +
  labs(
    x = "Umbral h",
    title = "ICM e ICM-CBF con Constant BF",
    subtitle = "NCM = KNN, LR y MAD  •  sin falsas alarmas",
    colour = NULL, linetype = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom",
        legend.box = "vertical")
```


## Mixture bf
```{r}
df_MIXT_VILLE <- df_all_methods_ville %>% filter(Method %in% c("KNN Mixture BF + ICM","LR Mixture BF + ICM", "MAD Mixture BF + ICM", "S-R Oracle", "Posterior Oracle", "CUSUM Oracle"))
ggplot(df_MIXT_VILLE,
       aes(x = threshold,
           y = mean_delay,
           colour   = Method,
           linetype = Method)) +
  geom_line(size = 0.9) +
  facet_grid(rows = vars(theta_stream),
             cols = vars(mu1),
             labeller = label_both) +
  scale_y_continuous("Retardo medio (observaciones)",
                     breaks = scales::pretty_breaks()) +
  labs(
    x = "Umbral h",
    title = "ICM e ICM-CBF con Mixture BF",
    subtitle = "NCM = KNN, LR y MAD  •  sin falsas alarmas",
    colour = NULL, linetype = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom",
        legend.box = "vertical")
```

##HISTOGRAM BF
```{r}
df_HIST_VILLE <- df_all_methods_ville %>% filter(Method %in% c("KNN Histogram BF + ICM","LR Histogram BF + ICM", "MAD Histogram BF + ICM","S-R Oracle", "Posterior Oracle", "CUSUM Oracle"))
ggplot(df_HIST_VILLE,
       aes(x = threshold,
           y = mean_delay,
           colour   = Method,
           linetype = Method)) +
  geom_line(size = 0.9) +
  facet_grid(rows = vars(theta_stream),
             cols = vars(mu1),
             labeller = label_both) +
  scale_y_continuous("Retardo medio (observaciones)",
                     breaks = scales::pretty_breaks()) +
  labs(
    x = "Umbral h",
    title = "ICM e ICM-CBF con Histogram BF",
    subtitle = "NCM = KNN, LR y MAD  •  sin falsas alarmas",
    colour = NULL, linetype = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom",
        legend.box = "vertical")
```
## KDE precompt
```{r}
df_KDE_VILLE <- df_all_methods_ville %>% filter(Method %in% c("KNN Precomputed KDE BF + ICM","LR Precomputed KDE BF + ICM", "MAD Precomputed KDE BF + ICM","S-R Oracle", "Posterior Oracle", "CUSUM Oracle"))
ggplot(df_KDE_VILLE,
       aes(x = threshold,
           y = mean_delay,
           colour   = Method,
           linetype = Method)) +
  geom_line(size = 0.9) +
  facet_grid(rows = vars(theta_stream),
             cols = vars(mu1),
             labeller = label_both) +
  scale_y_continuous("Retardo medio (observaciones)",
                     breaks = scales::pretty_breaks()) +
  labs(
    x = "Umbral h",
    title = "ICM e ICM-CBF con KDE precomp BF",
    subtitle = "NCM = KNN, LR y MAD  •  sin falsas alarmas",
    colour = NULL, linetype = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom",
        legend.box = "vertical")
```



